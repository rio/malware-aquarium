#!/bin/bash

set -euxo pipefail

function kill_port_forward() {
    kill $UPLOAD_PORT_FORWARD_PID
}

kubectl port-forward -n cdi svc/cdi-uploadproxy 8443:443 &

UPLOAD_PORT_FORWARD_PID=$!

trap kill_port_forward EXIT

virtctl image-upload dv $1 \
    --namespace vm-images \
    --size=25Gi \
    --image-path $1/* \
    --uploadproxy-url https://localhost:8443 \
    --access-mode ReadWriteOnce \
    --insecure
