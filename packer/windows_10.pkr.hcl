variable "iso_checksum" {
  type    = string
  default = "sha256:69efac1df9ec8066341d8c9b62297ddece0e6b805533fdb6dd66bc8034fba27a"
}

variable "iso_url" {
  type    = string
  default = "https://software-download.microsoft.com/download/sg/444969d5-f34g-4e03-ac9d-1f9786c69161/19044.1288.211006-0501.21h2_release_svc_refresh_CLIENTENTERPRISEEVAL_OEMRET_x64FRE_en-us.iso"
}

source "qemu" "windows-10" {
  accelerator      = "kvm"
  boot_wait        = "10m"
  communicator     = "winrm"
  cpus             = 2
  memory           = 2048
  disk_size        = "25G"
  headless         = true

  floppy_files     = [
    "./answer_files/10/Autounattend.xml",
    "./scripts/fixnetwork.ps1",
    "./scripts/disable-winrm.ps1",
    "./scripts/enable-winrm.ps1",
  ]

  iso_checksum     = "${var.iso_checksum}"
  iso_url          = "${var.iso_url}"

  output_directory = "build/windows_10-qemu"

  qemuargs         = [
    ["-drive", "file=build/windows_10-qemu/{{ .Name }},if=virtio,cache=writeback,discard=ignore,format=qcow2,index=1"],
    ["-drive", "file=${var.iso_url},media=cdrom,index=2"],
    ["-drive", "file=virtio-win.iso,media=cdrom,index=3"],
  ]

  shutdown_command = "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\""
  vm_name          = "windows_10"
  winrm_timeout    = "6h"
  winrm_username   = "alice"
  winrm_password   = "wonderland"
}

build {
  sources = [
    "source.qemu.windows-10",
  ]
}
