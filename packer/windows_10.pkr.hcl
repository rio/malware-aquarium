locals {
  iso_url = "https://software-download.microsoft.com/download/sg/444969d5-f34g-4e03-ac9d-1f9786c69161/19044.1288.211006-0501.21h2_release_svc_refresh_CLIENTENTERPRISEEVAL_OEMRET_x64FRE_en-us.iso"
  iso_checksum = "sha256:69efac1df9ec8066341d8c9b62297ddece0e6b805533fdb6dd66bc8034fba27a"
}

source "qemu" "windows-10" {
  accelerator      = "kvm"
  boot_wait        = "0s"
  communicator     = "winrm"
  cpus             = 4
  memory           = 8192
  disk_size        = "25G"
  headless         = true

  floppy_files     = [
    "./answer_files/10/Autounattend.xml",
    "./scripts/fixnetwork.ps1",
    "./scripts/disable-winrm.ps1",
    "./scripts/enable-winrm.ps1",
  ]

  cd_files         = [
    "./drivers/w10/*",
  ]

  output_directory = "build/{{ build_name }}.{{ isotime `2006-01-02.15-04-05` }}"

  iso_checksum     = "${local.iso_checksum}"
  iso_url          = "${local.iso_url}"

  shutdown_command = "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\""

  winrm_timeout    = "6h"
  winrm_username   = "alice"
  winrm_password   = "wonderland"
}

build {
  sources = [
    "source.qemu.windows-10",
  ]

  provisioner "powershell" {
    scripts = [
      "./scripts/enable-eventlogs.ps1",
      "./scripts/install-fluentbit.ps1",
      "./scripts/disable-screensaver.ps1",
      "./scripts/disable_AV_Firewall.ps1",
      "./scripts/create_folder+install_7zip.ps1",
      "./scripts/folder_monitor.ps1",
      "./scripts/install_osquery.ps1",
      "./scripts/enable_vul_services.ps1",  
    ]
  }

  provisioner "windows-restart" {
    restart_check_command = "powershell -command \"&{Write-Output 'restarted.'}\"" 
  }

   provisioner "powershell" {
    scripts = [
      "./scripts/after_restart.ps1",  
    ]
  }
}
