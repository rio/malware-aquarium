#!/bin/bash

set -euxo pipefail

cd build

function kill_port_forward() {
    kill $UPLOAD_PORT_FORWARD_PID
}

kubectl port-forward -n cdi svc/cdi-uploadproxy 8443:443 &

UPLOAD_PORT_FORWARD_PID=$!

trap kill_port_forward EXIT

set +e
for I in $(ls); do
    virtctl image-upload dv $I \
        --namespace vms \
        --size=40Gi \
        --image-path $I/* \
        --uploadproxy-url https://localhost:8443 \
        --access-mode ReadWriteOnce \
        --insecure
done
