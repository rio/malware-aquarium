variable "iso_checksum" {
  type    = string
  default = "sha256:549bca46c055157291be6c22a3aaaed8330e78ef4382c99ee82c896426a1cee1"
}

variable "iso_url" {
  type    = string
  default = "https://software-download.microsoft.com/download/pr/17763.737.190906-2324.rs5_release_svc_refresh_SERVER_EVAL_x64FRE_en-us_1.iso"
}

variable "virtio_win_iso" {
  type    = string
  default = "~/virtio-win.iso"
}


source "qemu" "windows-server-2019" {
  accelerator      = "kvm"
  boot_wait        = "0s"
  communicator     = "winrm"
  cpus             = 2
  memory           = 2048
  disk_size        = "25G"

  floppy_files     = [
    "./answer_files/2019/Autounattend.xml",
    // "./scripts/disable-screensaver.ps1",
    "./scripts/disable-winrm.ps1",
    "./scripts/enable-winrm.ps1",
    // "./scripts/microsoft-updates.bat",
    // "./scripts/unattend.xml",
    "./scripts/sysprep.bat",
    // "./scripts/win-updates.ps1",
  ]

  headless         = true
  iso_checksum     = "${var.iso_checksum}"
  iso_url          = "${var.iso_url}"

  output_directory = "build/windows_2019-qemu"

  qemuargs         = [
    ["-drive", "file=build/windows_2019-qemu/{{ .Name }},if=virtio,cache=writeback,discard=ignore,format=qcow2,index=1"],
    ["-drive", "file=${var.iso_url},media=cdrom,index=2"],
    ["-drive", "file=virtio-win.iso,media=cdrom,index=3"],
  ]

  shutdown_command = "a:/sysprep.bat"
  vm_name          = "WindowsServer2019"
  winrm_timeout    = "2h"
  winrm_username   = "alice"
  winrm_password   = "wonderland"
}

build {
  sources = [
    "source.qemu.windows-server-2019",
  ]
}
