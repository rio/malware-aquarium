locals {
  iso_url = "https://software-download.microsoft.com/download/pr/17763.737.190906-2324.rs5_release_svc_refresh_SERVER_EVAL_x64FRE_en-us_1.iso"
  iso_checksum = "sha256:549bca46c055157291be6c22a3aaaed8330e78ef4382c99ee82c896426a1cee1"
}

source "qemu" "windows-server-2019" {
  accelerator      = "kvm"
  boot_wait        = "0s"
  communicator     = "winrm"
  cpus             = 2
  memory           = 2048
  disk_size        = "25G"
  headless         = true

  floppy_files     = [
    "./answer_files/2019/Autounattend.xml",
    "./scripts/disable-winrm.ps1",
    "./scripts/enable-winrm.ps1",
    "./scripts/disable-screensaver.ps1",
    "./scripts/sysprep.bat",
    "./scripts/unattend.xml",
  ]

  cd_files = [
    "./drivers/2k19/*",
  ]

  iso_checksum     = "${local.iso_checksum}"
  iso_url          = "${local.iso_url}"

  output_directory = "build/{{ build_name }}.{{ isotime `2006-01-02.15-04-05` }}"

  shutdown_command = "a:/sysprep.bat"

  winrm_timeout    = "2h"
  winrm_username   = "alice"
  winrm_password   = "wonderland"
}

build {
  sources = [
    "source.qemu.windows-server-2019",
  ]
}
